id: org.naev.Naev
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
  - org.freedesktop.Sdk.Extension.llvm21
command: naev
rename-appdata-file: org.naev.Naev.metainfo.xml
finish-args:
  - --socket=pulseaudio
  - --socket=wayland
  - --socket=fallback-x11
  - --share=network
  - --device=dri
  - --share=ipc

modules:
  - name: cmark
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DBUILD_STATIC_LIBS=OFF
      - -DBUILD_SHARED_LIBS=ON
    cleanup:
      - /bin
      - /include
      - /lib/cmake
      - /lib/*.a
      - /lib/*.la
      - /lib/pkgconfig
      - /share/man
    sources:
      - type: git
        url: https://github.com/commonmark/cmark.git
        tag: 0.31.1
        commit: bb3678d7a73cb02d35c8876ecd097072636200a8
        x-checker-data:
          type: git
          tag-pattern: ^([\d.]+)$

  - name: enet
    buildsystem: autotools
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /lib/*.a
      - /lib/*.la
      - /share/man
    sources:
      - type: git
        url: https://github.com/lsalzman/enet.git
        tag: v1.3.18
        commit: 2662c0de09e36f2a2030ccc2c528a3e4c9e8138a
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$
      - type: script
        dest-filename: autogen.sh
        commands:
          - autoreconf -ifv

  - name: glpk
    no-autogen: false
    make-install-args:
      - PREFIX=/app
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /lib/*.a
      - /lib/*.la
      - /share/man
    sources:
      - type: archive
        url: https://ftpmirror.gnu.org/gnu/glpk/glpk-5.0.tar.gz
        sha512: 4e92195fa058c707146f2690f3a38b46c33add948c852f67659ca005a6aa980bbf97be96528b0f8391690facb880ac2126cd60198c6c175e7f3f06cca7e29f9d
        x-checker-data:
          type: anitya
          project-id: 1183
          stable-only: true
          url-template: https://ftpmirror.gnu.org/gnu/glpk/glpk-$version.tar.gz
      - type: patch
        path: minisat-c23-fix.patch

  - name: libunibreak
    no-autogen: false
    make-install-args:
      - PREFIX=/app
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /lib/*.a
      - /lib/*.la
      - /share/man
    sources:
      - type: archive
        url: https://github.com/adah1972/libunibreak/releases/download/libunibreak_6_1/libunibreak-6.1.tar.gz
        sha512: 8ffde29a9b90ddcbfabb61d7302ffe3b17473cd6d30fe1a4403d857e6191291d7e7a6f23bde58654155ed95f4a0f31e082cdf424a82da46722a811291ef38c2f
        x-checker-data:
          type: json
          url: https://api.github.com/repos/adah1972/libunibreak/releases/latest
          version-query: .tag_name
          url-query: .assets[] | select(.name|endswith(".tar.gz")) | .browser_download_url

  - shared-modules/luajit/luajit.json

  - name: nativefiledialog-extended
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DBUILD_STATIC_LIBS=ON
      - -DBUILD_SHARED_LIBS=OFF
    cleanup:
      - /bin
      - /include
      - /lib/cmake
      - /lib/*.a
      - /lib/*.la
      - /lib/pkgconfig
      - /share/man
    sources:
      - type: git
        url: https://github.com/btzy/nativefiledialog-extended.git
        tag: v1.3.0
        commit: fc168e8605bfa51aaec22ab0c4e46b9de665a437
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$

  - name: openblas
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DDYNAMIC_ARCH=OFF
      - -DTARGET=SANDYBRIDGE
      - -DBUILD_STATIC_LIBS=OFF
      - -DBUILD_SHARED_LIBS=ON
      - -DBUILD_WITHOUT_LAPACK=OFF
      - -DUSE_OPENMP=OFF
      - -DBUILD_TESTING=OFF
    build-options:
      arch:
        aarch64:
          config-opts:
            - -DTARGET=ARMV8
            - -DNO_SVE=ON
            - -DNO_SME=ON
    cleanup:
      - /bin
      - /include
      - /lib/cmake
      - /lib/*.a
      - /lib/*.la
      - /lib/pkgconfig
      - /share/man
    sources:
      - type: archive
        url: https://github.com/OpenMathLib/OpenBLAS/releases/download/v0.3.30/OpenBLAS-0.3.30.tar.gz
        sha512: c726ced2d3e6ebd3ddcd0b13c255bb43fae8c12d2aec15e9ef992b0bc7099996c02cd284ccaaa7b5fac3f23f280b098063dd60f521d97a68dc183ab192fcccdb
        x-checker-data:
          type: json
          url: https://api.github.com/repos/OpenMathLib/OpenBLAS/releases/latest
          version-query: .tag_name
          url-query: .assets[] | select(.name|endswith(".tar.gz")) | .browser_download_url

  - shared-modules/physfs/physfs.json

  - name: python3-pyyaml
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "pyyaml" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/05/8e/961c0007c59b8dd7729d542c61a4d537767a59645b82a0b521206e1e25c2/pyyaml-6.0.3.tar.gz
        sha256: d76623373421df22fb4cf8817020cbb7ef15c725b9d5e45f17e189bfc384190f
        x-checker-data:
          type: pypi
          name: PyYAML
          packagetype: sdist

  - name: suitesparse
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DBUILD_STATIC_LIBS=OFF
      - -DBUILD_SHARED_LIBS=ON
      - -DSUITESPARSE_USE_64BIT_BLAS=ON
      - -DSUITESPARSE_ENABLE_PROJECTS=cholmod;amd;colamd;cxsparse
    cleanup:
      - /bin
      - /include
      - /lib/cmake
      - /lib/*.a
      - /lib/*.la
      - /lib/pkgconfig
      - /share/man
    sources:
      - type: git
        url: https://github.com/DrTimothyAldenDavis/SuiteSparse.git
        tag: v7.12.1
        commit: 901381cd753c004cc2db8e91bdb48f1b51212d3d
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$

  - name: rust-bindgen
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/rust-stable/bin
      env:
        CARGO_HOME: /run/build/rust-bindgen/cargo
    sources:
      - type: git
        url: https://github.com/rust-lang/rust-bindgen/
        commit: d874de8d646d9b8a3e7ba2db2bcd52f2fba8f1f5
        tag: v0.72.1
      - rust-bindgen.json
    build-commands:
      - mv ./cargo/config ./cargo/config.toml
      - cargo --offline fetch --manifest-path ./Cargo.toml --verbose
      - cargo --offline build ${CARGO_RELEASE_FLAG---release} --verbose
      - install -m 755 ./target/${NAEV_BUILDTYPE:-release}/bindgen /app/bin/bindgen
    cleanup:
      - /bin
      - /include
      - /lib
      - /share

  - name: naev
    buildsystem: simple
    build-options:
      prepend-ld-library-path: /usr/lib/sdk/llvm21/lib
      append-path: /app/bin:/usr/lib/sdk/rust-stable/bin:/usr/lib/sdk/llvm21/bin
      env:
        LIBCLANG_PATH: /usr/lib/sdk/llvm21/lib
        CARGO_NET_OFFLINE: 'true'
    build-commands:
      - meson setup _flatpak_build --prefix=/app -Dbuildtype=${NAEV_BUILDTYPE:-release} -Db_lto=false
        -Dauto_features=enabled -Ddocs_c=disabled -Ddocs_lua=disabled
      - cp -vf Cargo.lock _flatpak_build/Cargo.lock
      - ninja -C _flatpak_build
      - ninja -C _flatpak_build install
    sources:
      - type: archive
        url: https://codeberg.org/naev/naev/releases/download/v0.13.2/naev-0.13.2-source.tar.xz
        sha512: ccb9dc8b92186ccf777be643e55a947c0026039f1f8c139cd3f6bb1310a83a3a53358d5ea99b172690a62c4aefb1bf15d5b6a93daf8cd2eb912b1a6866a07b48
        x-checker-data:
          type: json
          url: https://codeberg.org/api/v1/repos/naev/naev/releases/latest
          version-query: .tag_name
          url-query: .assets[] | select(.name|endswith("-source.tar.xz")) | .browser_download_url
      - type: patch
        path: metainfo.patch
      - type: file
        path: Cargo.lock
      - cargo-sources.json
      - type: shell
        commands:
          - mkdir -p _flatpak_build/.cargo _flatpak_build/cargo
          - cp -vf cargo/config _flatpak_build/.cargo/config.toml
          - mv cargo/vendor _flatpak_build/cargo
